<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragment/head :: head}"></head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">
	<header th:replace="~{fragment/header :: header}"></header>
	<div th:replace="~{fragment/sidebar :: sidebar}"></div>

	<div class="content-wrapper">
		<section class="content-header">
			<h1>Danh sách Đơn hàng<small>Quản lý các đơn hàng</small></h1>
		</section>

		<section class="content">
			<div class="row">
				<div class="col-xs-12">
					<div class="box">
						<div class="box-body">
							<form th:action="@{/admin/orders}" method="get" class="form-inline">
								<div class="form-group">
									<input type="text" name="customerName" class="form-control" placeholder="Nhập tên khách hàng..." th:value="${currentCustomerName}">
								</div>
								<div class="form-group" style="margin-left: 10px;">
									<select name="status" class="form-control">
										<option value="">-- Chọn tất cả trạng thái --</option>
										<option th:each="st : ${allStatuses}" th:value="${st}" th:text="${st}" th:selected="${st == currentStatus}"></option>
									</select>
								</div>
								<div class="form-group" style="margin-left: 10px;">
									<button type="submit" class="btn btn-primary"><i class="fa fa-search"></i> Lọc</button>
								</div>
								<div class="form-group" style="margin-left: 5px;">
									<a th:href="@{/admin/orders}" class="btn btn-default" title="Xóa bộ lọc"><i class="fa fa-times"></i></a>
								</div>
							</form>
							<br>

							<table class="table table-bordered table-striped">
								<thead>
								<tr>
									<th>Tên khách hàng</th>
									<th>Trạng thái</th>
									<th>Phương thức TT</th>
									<th>Ngày đặt</th>
									<th>Tổng tiền</th>
									<th>Hành động</th>
								</tr>
								</thead>
								<tbody>
								<tr th:each="order : ${ordersPage.content}">
									<td th:text="${order.customerName}"></td>
									<td>
										<span class="label" th:text="${order.status}" th:classappend="${order.status.name() == 'DELIVERED' ? 'label-success' : (order.status.name() == 'PENDING' ? 'label-warning' : (order.status.name() == 'CANCELLED' or order.status.name() == 'REJECTED' ? 'label-danger' : 'label-info'))}"></span>
									</td>
									<td th:text="${order.paymentMethod}"></td>
									<td th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}"></td>
									<td th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
									<td>
										<a th:href="@{/admin/orders/{id}(id=${order.id})}" class="btn btn-info btn-xs" title="Xem chi tiết"><i class="fa fa-eye"></i></a>
										<button type="button" class="btn btn-warning btn-xs" title="Cập nhật trạng thái" data-toggle="modal" th:data-target="'#updateStatusModal-' + ${order.id}">
											<i class="fa fa-edit"></i>
										</button>
									</td>
								</tr>
								<tr th:if="${ordersPage.empty}">
									<td colspan="6" class="text-center">Không tìm thấy đơn hàng nào</td>
								</tr>
								</tbody>
							</table>

							<div th:if="${ordersPage.totalPages > 1}" class="text-center">
								<ul class="pagination">
									<li th:class="${ordersPage.first} ? 'disabled' : ''">
										<a th:href="@{/admin/orders(page=${ordersPage.number - 1}, customerName=${currentCustomerName}, status=${currentStatus})}">&laquo;</a>
									</li>
									<li th:each="i : ${#numbers.sequence(0, ordersPage.totalPages - 1)}" th:class="${i == ordersPage.number} ? 'active' : ''">
										<a th:href="@{/admin/orders(page=${i}, customerName=${currentCustomerName}, status=${currentStatus})}" th:text="${i + 1}"></a>
									</li>
									<li th:class="${ordersPage.last} ? 'disabled' : ''">
										<a th:href="@{/admin/orders(page=${ordersPage.number + 1}, customerName=${currentCustomerName}, status=${currentStatus})}">&raquo;</a>
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
	</div>

	<footer th:replace="~{fragment/footer :: footer}"></footer>
</div>

<div th:each="order : ${ordersPage.content}">
	<div class="modal fade" th:id="'updateStatusModal-' + ${order.id}" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<form th:action="@{/admin/orders/update-status/{id}(id=${order.id})}" method="post">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" th:text="'Cập nhật đơn hàng #' + ${order.id}"></h4>
					</div>
					<div class="modal-body">
						<p><strong>Khách hàng:</strong> <span th:text="${order.customerName}"></span></p>
						<hr>
						<div class="form-group">
							<label>Chọn trạng thái mới</label>
							<select name="newStatus" class="form-control status-selector">
								<option th:each="s : ${T(com.group7.ecommerce.enums.OrderStatus).values()}" th:value="${s}" th:text="${s}" th:selected="${s == order.status}"></option>
							</select>
						</div>
						<div class="reason-block d-none">
							<div class="form-group">
								<label>Chọn lý do</label>
								<select name="reasonId" class="form-control">
									<option value="">-- Không chọn --</option>
									<option th:each="reason : ${allReasons}" th:value="${reason.id}" th:text="${reason.description}"></option>
								</select>
							</div>
							<div class="form-group">
								<label>Ghi chú chi tiết (tùy chọn)</label>
								<textarea name="adminNote" class="form-control" rows="3"></textarea>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
						<button type="submit" class="btn btn-success"><i class="fa fa-save"></i> Lưu thay đổi</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<div th:replace="~{fragment/script :: script}"></div>

</body>
</html>
